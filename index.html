<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twitter Clone</title>
    <link rel="stylesheet" href="/styles.css" />
</head>
<body>
    <div class="header">
        <h1>Twitter Clone</h1>
    </div>

    <div class="tab-bar">
        <button class="tab active" data-tab="tweets">Tweets</button>
        <button class="tab" data-tab="accounts">Accounts</button>
    </div>

    <div id="tweets-tab" class="tab-content active">
        <div class="tweet-form">
            <h2>Post a Tweet</h2>
            <div class="form-group">
                <label for="account-id">Account ID:</label>
                <input type="number" id="account-id" required />
            </div>
            <textarea id="tweet-content" placeholder="What's happening?" rows="4"></textarea>
            <button id="post-tweet">Tweet</button>
        </div>

        <div class="search-container">
            <input type="text" id="search-query" placeholder="Search tweets..." />
            <button id="search-tweets">Search</button>
            <button id="search-hashtags">Search #</button>
            <button id="refresh-tweets">Refresh All</button>
        </div>

        <div id="tweets-container"></div>
    </div>

    <div id="accounts-tab" class="tab-content">
        <div class="account-form">
            <h2>Create Account</h2>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" required />
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required />
            </div>
            <button id="create-account">Create Account</button>
        </div>

        <div class="search-container">
            <input type="text" id="account-search-query" placeholder="Search accounts..." />
            <button id="search-accounts">Search</button>
            <button id="list-accounts">List All</button>
        </div>

        <div id="accounts-container"></div>
    </div>

    <script>
        const API_URL = '/api';
        // Tab functionality: switches between Tweets and Accounts sections
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });

        // Fetch and display all tweets
        async function fetchTweets() {
            try {
                const response = await fetch(`${API_URL}/tweets/`);
                const tweets = await response.json();
                displayTweets(tweets);
            } catch (error) {
                console.error('Error fetching tweets:', error);
                alert('Failed to fetch tweets');
            }
        }

        // Render tweets into the tweets container
        function displayTweets(tweets) {
            const container = document.getElementById('tweets-container');
            container.innerHTML = '';
            if (tweets.length === 0) {
                container.innerHTML = '<p>No tweets found</p>';
                return;
            }
            tweets.forEach(tweet => {
                const tweetElement = document.createElement('div');
                tweetElement.className = 'tweet';
                tweetElement.innerHTML = `
                    <div class="tweet-header">User ID: ${tweet.account_id}</div>
                    <div class="tweet-content" id="content-${tweet.id}">${tweet.content}</div>
                    <div class="edit-form" id="edit-form-${tweet.id}">
                        <textarea id="edit-content-${tweet.id}">${tweet.content}</textarea>
                        <button onclick="updateTweet(${tweet.id})">Save</button>
                        <button onclick="cancelEdit(${tweet.id})">Cancel</button>
                    </div>
                    <div class="tweet-actions">
                        <button class="action-btn" onclick="showEditForm(${tweet.id})">Edit</button>
                        <button class="action-btn" onclick="deleteTweet(${tweet.id})">Delete</button>
                    </div>
                `;
                container.appendChild(tweetElement);
            });
        }

        // Show edit form for a specific tweet
        function showEditForm(tweetId) {
            document.getElementById(`content-${tweetId}`).style.display = 'none';
            document.getElementById(`edit-form-${tweetId}`).style.display = 'block';
        }

        // Cancel editing a tweet
        function cancelEdit(tweetId) {
            document.getElementById(`content-${tweetId}`).style.display = 'block';
            document.getElementById(`edit-form-${tweetId}`).style.display = 'none';
        }

        // Update a tweet via API
        async function updateTweet(tweetId) {
            const content = document.getElementById(`edit-content-${tweetId}`).value;
            try {
                const response = await fetch(`${API_URL}/tweets/${tweetId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (response.ok) {
                    const updatedTweet = await response.json();
                    document.getElementById(`content-${tweetId}`).textContent = updatedTweet.content;
                    cancelEdit(tweetId);
                } else {
                    alert('Failed to update tweet');
                }
            } catch (error) {
                console.error('Error updating tweet:', error);
                alert('Failed to update tweet');
            }
        }

        // Delete a tweet via API
        async function deleteTweet(tweetId) {
            if (confirm('Are you sure you want to delete this tweet?')) {
                try {
                    const response = await fetch(`${API_URL}/tweets/${tweetId}`, { method: 'DELETE' });
                    if (response.ok) {
                        fetchTweets();
                    } else {
                        alert('Failed to delete tweet');
                    }
                } catch (error) {
                    console.error('Error deleting tweet:', error);
                    alert('Failed to delete tweet');
                }
            }
        }

        // Post a new tweet
        document.getElementById('post-tweet').addEventListener('click', async () => {
            const accountId = document.getElementById('account-id').value;
            const content = document.getElementById('tweet-content').value;
            if (!accountId || !content) {
                alert('Please fill in all fields');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/tweets/${accountId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (response.ok) {
                    document.getElementById('tweet-content').value = '';
                    fetchTweets();
                } else {
                    const error = await response.json();
                    alert(`Failed to post tweet: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error posting tweet:', error);
                alert('Failed to post tweet');
            }
        });

        // Search tweets by keyword
        document.getElementById('search-tweets').addEventListener('click', async () => {
            const query = document.getElementById('search-query').value;
            if (!query) {
                fetchTweets();
                return;
            }
            try {
                const response = await fetch(`${API_URL}/tweets/search/?keyword=${encodeURIComponent(query)}`);
                const tweets = await response.json();
                displayTweets(tweets);
            } catch (error) {
                console.error('Error searching tweets:', error);
                alert('Failed to search tweets');
            }
        });

        // Search tweets by hashtag
        document.getElementById('search-hashtags').addEventListener('click', async () => {
            const query = document.getElementById('search-query').value.replace('#', '');
            if (!query) {
                alert('Please enter a hashtag to search');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/tweets/hashtags/${encodeURIComponent(query)}`);
                const tweets = await response.json();
                displayTweets(tweets);
            } catch (error) {
                console.error('Error searching hashtags:', error);
                alert('Failed to search hashtags');
            }
        });

        // Refresh tweets list
        document.getElementById('refresh-tweets').addEventListener('click', fetchTweets);

        // Create a new account
        document.getElementById('create-account').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            if (!username || !email) {
                alert('Please fill in all fields');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/accounts/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });
                if (response.ok) {
                    const account = await response.json();
                    alert(`Account created successfully! Your ID is: ${account.id}`);
                    document.getElementById('username').value = '';
                    document.getElementById('email').value = '';
                    fetchAccounts();
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Unknown error';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || 'Unknown error';
                    } catch {
                        errorMessage = errorText || 'Unknown error';
                    }
                    alert(`Failed to create account: ${errorMessage}`);
                    console.error('Error response:', errorText);
                }
            } catch (error) {
                console.error('Error creating account:', error);
                alert(`Failed to create account: ${error.message}`);
            }
        });

        // Fetch and display all accounts
        async function fetchAccounts() {
            try {
                const response = await fetch(`${API_URL}/accounts/`);
                const accounts = await response.json();
                displayAccounts(accounts);
            } catch (error) {
                console.error('Error fetching accounts:', error);
                alert('Failed to fetch accounts');
            }
        }

        // Render accounts into the accounts container
        function displayAccounts(accounts) {
            const container = document.getElementById('accounts-container');
            container.innerHTML = '';
            if (accounts.length === 0) {
                container.innerHTML = '<p>No accounts found</p>';
                return;
            }
            accounts.forEach(account => {
                const accountElement = document.createElement('div');
                accountElement.className = 'tweet';
                accountElement.innerHTML = `
                    <div class="tweet-header">Username: ${account.username}</div>
                    <div class="tweet-content">
                        <p>ID: ${account.id}</p>
                        <p>Email: ${account.email}</p>
                        <p>Created: ${new Date(account.created_at).toLocaleString()}</p>
                    </div>
                `;
                container.appendChild(accountElement);
            });
        }

        // Search accounts by query
        document.getElementById('search-accounts').addEventListener('click', async () => {
            const query = document.getElementById('account-search-query').value;
            if (!query) {
                fetchAccounts();
                return;
            }
            try {
                const response = await fetch(`${API_URL}/accounts/search/?query=${encodeURIComponent(query)}`);
                const accounts = await response.json();
                displayAccounts(accounts);
            } catch (error) {
                console.error('Error searching accounts:', error);
                alert('Failed to search accounts');
            }
        });

        // List all accounts
        document.getElementById('list-accounts').addEventListener('click', fetchAccounts);

        // Initial load of tweets on page load
        fetchTweets();
    </script>
</body>
</html>
